<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write Review - UUM FoodHunt</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F97316">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: '#F97316', // Orange-500
                        secondary: '#FDBA74', // Orange-300
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 antialiased pb-10">

    <!-- Sticky Header -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm px-5 py-4 flex items-center justify-between transition-all duration-300">
        <a href="home.html" class="text-slate-500 hover:text-slate-800 font-medium text-sm">Cancel</a>
        <h1 class="text-lg font-bold tracking-tight text-slate-900">Write Review</h1>
        <div class="w-10"></div> <!-- Spacer for centering -->
    </header>

    <main class="px-5 mt-6 max-w-md mx-auto sm:max-w-xl md:max-w-2xl">
        
        <form id="reviewForm" class="space-y-6">
            
            <!-- Photo Upload Area (Top) -->
            <div class="relative group">
                <input type="file" id="photo" accept="image/*" class="hidden" onchange="previewImage(this)">
                <label for="photo" class="block w-full h-48 bg-slate-100 rounded-3xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 hover:border-primary transition-all overflow-hidden relative">
                    <div id="uploadPlaceholder" class="flex flex-col items-center text-slate-400">
                        <i class="fa-solid fa-camera text-3xl mb-2"></i>
                        <span class="text-xs font-bold uppercase tracking-wide">Add Photo</span>
                    </div>
                    <img id="imagePreview" class="hidden absolute inset-0 w-full h-full object-cover" />
                    <div class="absolute bottom-3 right-3 bg-black/50 text-white p-2 rounded-full hidden" id="changePhotoIcon">
                        <i class="fa-solid fa-pen text-xs"></i>
                    </div>
                </label>
            </div>

            <!-- Details -->
            <div class="space-y-4">
                
                <!-- Restaurant -->
                <div>
                     <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-2 pl-1">Restaurant</label>
                    <input type="text" id="restaurantName" placeholder="Where are you eating?" class="w-full px-5 py-4 bg-white shadow-sm border border-slate-100 rounded-2xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all font-medium text-slate-800 placeholder-slate-400" required>
                </div>

                <!-- Food -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-2 pl-1">Food Name</label>
                    <input type="text" id="foodName" placeholder="What are you having?" class="w-full px-5 py-4 bg-white shadow-sm border border-slate-100 rounded-2xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all font-medium text-slate-800 placeholder-slate-400" required>
                </div>

                <!-- Price & Rating Row -->
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-2 pl-1">Price</label>
                        <div class="relative">
                            <span class="absolute left-4 top-4 text-slate-400 font-bold">RM</span>
                            <input type="number" id="price" step="0.01" placeholder="0.00" class="w-full pl-12 pr-4 py-4 bg-white shadow-sm border border-slate-100 rounded-2xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all font-bold text-slate-800" required>
                        </div>
                    </div>
                    <div class="flex-1">
                         <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-2 pl-1">Rating</label>
                        <div class="relative">
                            <select id="rating" class="w-full pl-4 pr-10 py-4 bg-white shadow-sm border border-slate-100 rounded-2xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all font-bold text-slate-800 appearance-none">
                                <option value="5">5 - Excellent</option>
                                <option value="4">4 - Good</option>
                                <option value="3" selected>3 - Average</option>
                                <option value="2">2 - Poor</option>
                                <option value="1">1 - Terrible</option>
                            </select>
                             <div class="absolute right-4 top-4 pointer-events-none text-slate-400">
                                <i class="fa-solid fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review -->
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-2 pl-1">Your Review</label>
                    <textarea id="reviewText" rows="4" placeholder="How was the taste? Is it worth it?" class="w-full px-5 py-4 bg-white shadow-sm border border-slate-100 rounded-2xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all font-medium text-slate-800 placeholder-slate-400 resize-none" required></textarea>
                </div>

                <!-- Location -->
                 <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-2 pl-1">Location</label>
                    <div class="flex gap-2">
                        <input type="text" id="location" placeholder="Add location tag (Optional)" class="flex-1 px-5 py-4 bg-white shadow-sm border border-slate-100 rounded-2xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all font-medium text-slate-800 placeholder-slate-400" readonly>
                        <button type="button" id="getLocationBtn" class="px-5 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 active:scale-95 transition-all">
                             <i class="fa-solid fa-location-crosshairs text-lg"></i>
                        </button>
                    </div>
                     <div id="locationInfo" class="hidden mt-2 p-2 text-xs text-slate-400 text-center">
                        GPS: <span id="coords"></span>
                    </div>
                </div>

            </div>

             <button type="submit" class="w-full bg-primary text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-orange-500/30 hover:shadow-orange-500/40 hover:-translate-y-1 active:scale-95 transition-all mt-8 mb-10 block">
                Post Review
            </button>

        </form>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm z-[60] flex flex-col items-center justify-center">
             <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
             <p class="font-bold text-slate-600 animate-pulse">Posting review...</p>
        </div>
        
        <!-- Success Message (Toast) -->
        <div id="successMessage" class="hidden fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-4 rounded-full shadow-2xl flex items-center gap-3 z-[70] min-w-[300px] justify-center">
            <i class="fa-solid fa-circle-check text-green-400 text-xl"></i>
            <span class="font-medium">Review posted!</span>
        </div>

    </main>

<script>
// Ensure user logged in
const currentUser = localStorage.getItem("currentUser");
if(!currentUser) window.location.href="login.html";

let currentLatitude = null;
let currentLongitude = null;

function previewImage(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreview').classList.remove('hidden');
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('changePhotoIcon').classList.remove('hidden');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// Get GPS Location
document.getElementById('getLocationBtn').addEventListener('click', () => {
  const locationInput = document.getElementById('location');
  const locationInfo = document.getElementById('locationInfo');
  const coordsSpan = document.getElementById('coords');
  const btn = document.getElementById('getLocationBtn');
  const icon = btn.querySelector('i');
  
  if (!navigator.geolocation) {
    alert('Geolocation is not supported by your browser');
    return;
  }
  
  btn.disabled = true;
  icon.classList.remove('fa-location-crosshairs');
  icon.classList.add('fa-circle-notch', 'fa-spin');
  
  navigator.geolocation.getCurrentPosition(
    async (position) => {
      currentLatitude = position.coords.latitude;
      currentLongitude = position.coords.longitude;
      
      // Show coordinates
      coordsSpan.textContent = `${currentLatitude.toFixed(6)}, ${currentLongitude.toFixed(6)}`;
      locationInfo.classList.remove('hidden');
      
      // Try to get address using reverse geocoding (OpenStreetMap Nominatim API)
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLatitude}&lon=${currentLongitude}`
        );
        const data = await response.json();
        
        if (data.display_name) {
             // Simplify address: only first 2 parts
           const parts = data.display_name.split(',');
           const simpleAddress = parts.slice(0, 2).join(', ');
          locationInput.value = simpleAddress;
        } else {
          locationInput.value = `Lat: ${currentLatitude.toFixed(4)}, Lon: ${currentLongitude.toFixed(4)}`;
        }
      } catch (error) {
        console.error('Error getting address:', error);
        locationInput.value = `Lat: ${currentLatitude.toFixed(4)}, Lon: ${currentLongitude.toFixed(4)}`;
      }
      
      btn.disabled = false;
      icon.classList.remove('fa-circle-notch', 'fa-spin');
      icon.classList.add('fa-check', 'text-green-500');
      
      // Reset icon after 2s
      setTimeout(() => {
          icon.classList.remove('fa-check', 'text-green-500');
          icon.classList.add('fa-location-crosshairs');
      }, 2000);

    },
    (error) => {
      console.error('Error getting location:', error);
      alert('Unable to get location: ' + error.message);
      btn.disabled = false;
      icon.classList.remove('fa-circle-notch', 'fa-spin');
      icon.classList.add('fa-location-crosshairs');
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
});

// Handle form submission
document.getElementById('reviewForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Show loading
  const loadingOverlay = document.getElementById('loadingOverlay');
  loadingOverlay.classList.remove('hidden');

  const formData = new FormData();
  formData.append('user_id', currentUser);
  formData.append('restaurant_name', document.getElementById('restaurantName').value);
  formData.append('food_name', document.getElementById('foodName').value);
  formData.append('review_text', document.getElementById('reviewText').value);
  formData.append('price', document.getElementById('price').value);
  formData.append('rating', document.getElementById('rating').value);
  formData.append('location', document.getElementById('location').value);
  formData.append('review_date', moment().format('YYYY-MM-DD'));
  
  // Add photo if selected
  const photoInput = document.getElementById('photo');
  if (photoInput.files.length > 0) {
    formData.append('photo', photoInput.files[0]);
  }
  
  try {
    const response = await fetch('../create_review.php', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    // Hide loading
    loadingOverlay.classList.add('hidden');

    if (data.success) {
      const successMsg = document.getElementById('successMessage');
      successMsg.classList.remove('hidden');
      
      setTimeout(() => {
        window.location.href = 'my_reviews.html';
      }, 1500);

    } else {
      alert('Error creating review: ' + data.message);
    }
  } catch (error) {
    loadingOverlay.classList.add('hidden');
    console.error('Error submitting review:', error);
    alert('Error submitting review. Please try again.');
  }
});
</script>

</body>
</html>
